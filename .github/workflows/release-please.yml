---
name: Release Please

on:
  workflow_call:
    inputs:
      config-file:
        required: false
        type: string
        description: release-please config file path
        default: .release-please/config.json
      manifest-file:
        required: false
        type: string
        description: release-please manifest file path
        default: .release-please/manifest.json
      generate-release-notes:
        required: false
        type: boolean
        description: Replace release-please release notes with GitHub auto-generated notes.
        default: false

    outputs:
      release-please:
        value: ${{ jobs.release-please.outputs.raw }}

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      raw: ${{ toJSON(steps.release-please.outputs) }}
    steps:
      - name: Release Please
        uses: googleapis/release-please-action@v4
        id: release-please
        with:
          config-file: .release-please/config.json
          manifest-file: .release-please/manifest.json

  generate-release-notes:
    runs-on: ubuntu-latest
    needs:
      - release-please
    if: >
      inputs.generate-release-notes == true
      && fromJSON(fromJSON(needs.release-please.outputs.raw).releases_created)
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Update Release Notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          sha="${{ fromJSON(needs.release-please.outputs.raw).sha }}"
          pr_number="$(gh pr list --state merged --search "$sha" --json number | jq .[0].number)"

          tag_name=${{ fromJSON(needs.release-please.outputs.raw).tag_name }}
          body=$(
            gh api \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/releases/generate-notes" \
              -f "tag_name=$tag_name" \
              --jq .body \
              | sed "/pull\/$pr_number$/d"
          )
          gh release edit "$tag_name" --notes "$body"
